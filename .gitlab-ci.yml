include:
  - project: 'moonraker/common'
    file: '.gitlab-ci-templates.yml'
    ref: master

stages:
  - increment_version
  - build
  - deploy

variables:
  CHART_NAME: coinbase-train
  K8S_NAMESPACE: moonraker
  NEXT_RELEASE_TYPE: minor
  RELEASE_NAME: $CI_COMMIT_REF_NAME-coinbase-btc-usd-train

.create_credentials_ini_file: &create_credentials_ini_file |
  cat << EOF > gitlab_credentials.ini
  [CREDENTIALS]
  GITLAB_PASSWORD = $CI_TOKEN
  GITLAB_USERNAME = $CI_USERNAME
  EOF

.helm_deploy_args: &helm_deploy_args |
  --set mongodb_url=mongodb+srv://sacred_ci_user:${SACRED_CI_USER_PASSWORD}@sacred-2ykvv.gcp.mongodb.net/test?retryWrites=true&w=majority
  --set moonraker-common.registry.username=$CI_USERNAME
  --set moonraker-common.registry.password=$CI_TOKEN
  --set service_account_json=$SERVICE_ACCOUNT_JSON
  --set ENVIRONMENT=staging/$CI_COMMIT_REF_NAME

increment_version:increment_version:
  extends: .increment_version

build:run_tests:
  extends: .base_test

  image: python:3.6

  script:
    - make install
    - make test

  stage: build

  variables:
    GITLAB_PASSWORD: $CI_TOKEN
    GITLAB_USERNAME: $CI_USERNAME

build:build_gpu_image:
  extends: .build_image

  before_script:
    - *create_credentials_ini_file

  variables:
   DOCKER_ARGS: '--secret id=gitlab_credentials.ini,src=gitlab_credentials.ini -f dockerfiles/Dockerfile.gpu'
   DOCKER_BUILDKIT: 1
   DOCKER_REPO: $CI_REGISTRY_IMAGE/gpu

build:build_cpu_image:
  extends: .build_image

  before_script:
    - *create_credentials_ini_file

  variables:
   DOCKER_ARGS: '--secret id=gitlab_credentials.ini,src=gitlab_credentials.ini -f dockerfiles/Dockerfile.cpu'
   DOCKER_BUILDKIT: 1
   DOCKER_REPO: $CI_REGISTRY_IMAGE/cpu

build:package_helm_chart:
  extends: .package_helm_chart

  variables:
    HELM_ARGS: "--dependency-update"
    CHART_NAME: coinbase-train

build:deploy_helm_chart_dry_run:
  extends: .deploy_helm_chart_dry_run

  variables:
    CHART_PATH: helm/coinbase-train
    HELM_ARGS: *helm_deploy_args

deploy:deploy_coinbase_train:
  environment:
    name: staging/$CI_COMMIT_REF_NAME
    on_stop: deploy:delete_coinbase_train

  extends: .deploy_helm_chart

  variables:
    HELM_ARGS: *helm_deploy_args

deploy:delete_coinbase_train:
  environment:
    name: staging/$CI_COMMIT_REF_NAME
    action: stop

  extends: .delete_helm_release
