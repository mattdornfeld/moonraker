include:
  - project: 'moonraker/common'
    file: '.gitlab-ci-templates.yml'
    ref: master

stages:
  - increment_version
  - build
  - deploy

variables:
  NEXT_RELEASE_TYPE: minor
  RELEASE_NAME: coinbase-btc-usd-train

.create_credentials_ini_file: &create_credentials_ini_file |
  cat << EOF > gitlab_credentials.ini
  [CREDENTIALS]
  GITLAB_PASSWORD = $CI_TOKEN
  GITLAB_USERNAME = $CI_USERNAME
  EOF

.helm_deploy_args: &helm_deploy_args |
  $HELM_DEPLOY_ARGS
  --force
  --set moonraker-common.registry.username=$CI_USERNAME
  --set moonraker-common.registry.password=$CI_TOKEN
  --set service_account_json=$SERVICE_ACCOUNT_JSON

increment_version:increment_version:
  extends: .increment_version

build:build_gpu_image:
  extends: .build_image

  before_script:
    - *create_credentials_ini_file

  stage: build

  variables:
   DOCKER_ARGS: '--secret id=gitlab_credentials.ini,src=gitlab_credentials.ini -f dockerfiles/Dockerfile.gpu'
   DOCKER_BUILDKIT: 1
   DOCKER_REPO: $CI_REGISTRY_IMAGE/gpu

build:build_cpu_image:
  extends: .build_image

  before_script:
    - *create_credentials_ini_file

  stage: build

  variables:
   DOCKER_ARGS: '--secret id=gitlab_credentials.ini,src=gitlab_credentials.ini -f dockerfiles/Dockerfile.cpu'
   DOCKER_BUILDKIT: 1
   DOCKER_REPO: $CI_REGISTRY_IMAGE/cpu

build:package_helm_chart:
  extends: .package_helm_chart

  variables:
    HELM_ARGS: "--dependency-update"
    CHART_NAME: coinbase-train

deploy:deploy_coinbase_train_to_staging:
  environment:
    name: staging
    on_stop: deploy:delete_coinbase_train_from_staging

  extends: .deploy_helm_chart

  variables:
    CHART_NAME: coinbase-train
    HELM_ARGS: *helm_deploy_args
    K8S_NAMESPACE: moonraker

deploy:delete_coinbase_train_from_staging:
  environment:
    name: staging
    action: stop

  extends: .delete_helm_release
