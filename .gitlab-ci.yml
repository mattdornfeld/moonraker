include:
  - project: 'moonraker/common'
    file: '.gitlab-ci-templates.yml'
    ref: master

stages:
  - build
  - deploy

variables:
  CHART_NAME: coinbase-train
  K8S_NAMESPACE: moonraker
  NEXT_RELEASE_TYPE: minor
  RELEASE_NAME: $CI_COMMIT_REF_NAME-coinbase-btc-usd-train

.create_credentials_ini_file: &create_credentials_ini_file |
  cat << EOF > gitlab_credentials.ini
  [CREDENTIALS]
  GITLAB_PASSWORD = $CI_TOKEN
  GITLAB_USERNAME = $CI_USERNAME
  EOF

.helm_deploy_args: &helm_deploy_args |
  HELM_ARGS="--set CI_TOKEN=${CI_TOKEN}
  --set ENVIRONMENT=staging/${CI_COMMIT_REF_NAME}
  --set mongodb_url=mongodb+srv://sacred_ci_user:${SACRED_CI_USER_PASSWORD}@sacred-2ykvv.gcp.mongodb.net/test?retryWrites=true&w=majority
  --set moonraker-common.registry.username=${CI_USERNAME}
  --set moonraker-common.registry.password=${CI_TOKEN}
  --set ray.head_deployment.docker_image=${CI_REGISTRY_IMAGE}/cpu:${VERSION_TAG}
  --set ray.worker_deployments.cpu-workers.docker_image=${CI_REGISTRY_IMAGE}/cpu:${VERSION_TAG}
  --set service_account_json=${SERVICE_ACCOUNT_JSON}"

.version_tag_script: &version_tag_script |
  echo 'export VERSION_TAG environment variable' && set -o allexport && if [ -f "semantic_version.env" ]; then source semantic_version.env; else VERSION_TAG=0.1.0-${CI_COMMIT_SHA}; fi && set +o allexport
  export VERSION_TAG

build:run_tests:
  extends: .base_test

  image: registry.gitlab.com/moonraker/base_images/coinbase_train_cpu:0.1.0-e1290d5beaa0d65f1a38494c81a08e58cbd0f1d2

  script:
    - make install
    - make test

  stage: build

  variables:
    GITLAB_PASSWORD: $CI_TOKEN
    GITLAB_USERNAME: $CI_USERNAME

build:build_gpu_image:
  extends: .build_image

  before_script:
    - *create_credentials_ini_file

  variables:
   DOCKER_ARGS: '--secret id=gitlab_credentials.ini,src=gitlab_credentials.ini -f dockerfiles/Dockerfile.gpu'
   DOCKER_BUILDKIT: 1
   DOCKER_REPO: $CI_REGISTRY_IMAGE/gpu

build:build_cpu_image:
  extends: .build_image

  before_script:
    - *create_credentials_ini_file

  variables:
   DOCKER_ARGS: '--secret id=gitlab_credentials.ini,src=gitlab_credentials.ini -f dockerfiles/Dockerfile.cpu'
   DOCKER_BUILDKIT: 1
   DOCKER_REPO: $CI_REGISTRY_IMAGE/cpu

build:package_helm_chart:
  extends: .package_helm_chart

  variables:
    HELM_ARGS: "--dependency-update"
    CHART_NAME: coinbase-train

build:deploy_helm_chart_dry_run:
  # We do this in the before_script here because Gitlab had trouble interpolating the VERSION_TAG variable
  # passing helm_deploy_args in as an environment variable
  before_script:
    - *version_tag_script
    - *helm_deploy_args

  extends: .deploy_helm_chart_dry_run

  variables:
    CHART_PATH: helm/coinbase-train

deploy:deploy_coinbase_train:
  before_script:
    - *version_tag_script
    - *helm_deploy_args

  environment:
    name: staging/$CI_COMMIT_REF_NAME
    on_stop: deploy:delete_coinbase_train

  extends: .deploy_helm_chart

deploy:delete_coinbase_train:
  environment:
    name: staging/$CI_COMMIT_REF_NAME
    action: stop

  extends: .delete_helm_release
